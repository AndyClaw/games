name: Gemini AI Agent (Flash Latest + Context)
on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  gemini-job:
    if: contains(github.event.comment.body, '@gemini-cli') || contains(github.event.issue.body, '@gemini-cli')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Configure Git
        run: |
          git config --global user.name "gemini-bot"
          git config --global user.email "gemini-bot@google.com"

      - name: Run Gemini Agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Context variables for the agent
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Cooling down for 15 seconds..."
          sleep 15

          # Injecting context directly into the prompt
          USER_INPUT="${{ github.event.comment.body || github.event.issue.body }}"
          CONTEXT_PROMPT="[CONTEXT: You are responding to Issue #$ISSUE_NUMBER in $REPO. Please read the issue history using the 'gh' tool if needed.] $USER_INPUT"

          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = false ]; do
            echo "Attempt $ATTEMPT using gemini-3-flash..."
            # Using 'gemini flash' for PhD-level reasoning at Flash speeds
            if gemini --model gemini-flash-latest --yolo "$CONTEXT_PROMPT"; then
              SUCCESS=true
            else
              echo "Rate limit or API error. Retrying in 60 seconds..."
              sleep 60
              ATTEMPT=$((ATTEMPT+1))
            fi
          done

          if [ "$SUCCESS" = false ]; then exit 1; fi
          
