name: Gemini AI Agent (Flash + Retry)
on:
  issue_comment:
    types: [created]
  issues:
    types: [opened]

jobs:
  gemini-job:
    if: contains(github.event.comment.body, '@gemini-cli') || contains(github.event.issue.body, '@gemini-cli')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      - name: Configure Git
        run: |
          git config --global user.name "gemini-bot"
          git config --global user.email "gemini-bot@google.com"

      - name: Run Gemini Agent with Retries
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Initial delay to ensure the API 'cools down' from any previous runs
          echo "Waiting 15 seconds to prevent immediate rate limit..."
          sleep 15

          # 2. Extract prompt (from comment or issue body)
          PROMPT="${{ github.event.comment.body || github.event.issue.body }}"

          # 3. Execution loop with 429 (Rate Limit) detection
          MAX_ATTEMPTS=3
          ATTEMPT=1
          SUCCESS=false

          while [ $ATTEMPT -le $MAX_ATTEMPTS ] && [ "$SUCCESS" = false ]; do
            echo "Attempt $ATTEMPT of $MAX_ATTEMPTS..."
            
            # Use gemini-1.5-flash for much higher RPM limits
            if gemini --model gemini-1.5-flash --yolo "$PROMPT"; then
              SUCCESS=true
              echo "Task completed successfully."
            else
              echo "Request failed or rate limited. Waiting 60 seconds before retry..."
              sleep 60
              ATTEMPT=$((ATTEMPT+1))
            fi
          done

          if [ "$SUCCESS" = false ]; then
            echo "Failed after $MAX_ATTEMPTS attempts."
            exit 1
          fi
          
