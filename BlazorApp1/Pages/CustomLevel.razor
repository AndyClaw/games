@page "/snake/custom"
@implements IDisposable
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject BlazorApp1.Services.SnakeGameEngine GameEngine

<PageTitle>Custom Snake Level</PageTitle>

<h1>Custom Level Creator</h1>

<div class="custom-level-container">
    @if (!levelStarted)
    {
        <div class="editor-with-preview">
            <div class="level-editor">
                <h2>Create Your Level</h2>
                
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" @bind="description" @bind:event="oninput" placeholder="My Custom Level" class="form-control" />
                </div>

                <div class="form-group">
                    <label>End Portal (row,col):</label>
                    <input @ref="portalInputRef" type="text" @bind="portalInput" @bind:event="onchange"
                           @oninput="@((ChangeEventArgs e) => portalInput = e.Value?.ToString() ?? "")"
                           @onfocus="@(() => focusedField = "portal")"
                           @onblur="@(() => focusedField = "")"
                           placeholder="17,14" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Snake Segments (row,col;row,col;... head first):</label>
                    <input @ref="snakeInputRef" type="text" @bind="snakeInput" @bind:event="onchange"
                           @oninput="@((ChangeEventArgs e) => snakeInput = e.Value?.ToString() ?? "")"
                           @onfocus="@(() => focusedField = "snake")"
                           @onblur="@(() => focusedField = "")"
                           placeholder="17,3;17,2;17,1" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Apples (row,col;row,col;... optional):</label>
                    <input @ref="applesInputRef" type="text" @bind="applesInput" @bind:event="onchange"
                           @oninput="@((ChangeEventArgs e) => applesInput = e.Value?.ToString() ?? "")"
                           @onfocus="@(() => focusedField = "apples")"
                           @onblur="@(() => focusedField = "")"
                           placeholder="15,10;17,14" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Ground Blocks (row,col;row,col;...):</label>
                    <textarea @ref="groundInputRef" @bind="groundInput" @bind:event="onchange"
                              @oninput="@((ChangeEventArgs e) => groundInput = e.Value?.ToString() ?? "")"
                              @onfocus="@(() => focusedField = "ground")"
                              @onblur="@(() => focusedField = "")"
                              placeholder="18,2;18,3;18,4" class="form-control" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Pushable Blocks (row,col;row,col;... optional):</label>
                    <input @ref="pushableInputRef" type="text" @bind="pushableInput" @bind:event="onchange"
                           @oninput="@((ChangeEventArgs e) => pushableInput = e.Value?.ToString() ?? "")"
                           @onfocus="@(() => focusedField = "pushable")"
                           @onblur="@(() => focusedField = "")"
                           placeholder="17,5" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Bombs (row,col;row,col;... optional):</label>
                    <input @ref="bombsInputRef" type="text" @bind="bombsInput" @bind:event="onchange"
                           @oninput="@((ChangeEventArgs e) => bombsInput = e.Value?.ToString() ?? "")"
                           @onfocus="@(() => focusedField = "bombs")"
                           @onblur="@(() => focusedField = "")"
                           placeholder="17,10" class="form-control" />
                </div>

            <div class="button-group">
                <button class="game-button" @onclick="PlayLevel">Play Level</button>
                <button class="game-button" @onclick="ShareLevel">Share Level</button>
                <button class="game-button" @onclick="SaveLevel">Save Level</button>
                <button class="game-button secondary" @onclick="BackToMenu">Back to Menu</button>
            </div>

            @if (showSavePrompt)
            {
                <div class="save-section">
                    <h3>Save Level</h3>
                    <div class="form-group">
                        <label>Level Name:</label>
                        <input type="text" @bind="saveLevelName" placeholder="My Awesome Level" class="form-control" />
                    </div>
                    <div class="button-group">
                        <button class="game-button" @onclick="ConfirmSaveLevel">Confirm Save</button>
                        <button class="game-button secondary" @onclick="CancelSave">Cancel</button>
                    </div>
                </div>
            }

            @if (savedLevels.Any())
            {
                <div class="saved-levels-section">
                    <h3>Saved Levels</h3>
                    <div class="saved-levels-list">
                        @foreach (var level in savedLevels)
                        {
                            <div class="saved-level-item">
                                <span class="saved-level-name" @onclick="() => LoadSavedLevel(level.Key)">@level.Key</span>
                                <button class="delete-button" @onclick="() => DeleteSavedLevel(level.Key)">üóëÔ∏è</button>
                            </div>
                        }
                    </div>
                </div>
            }

            @if (showShareUrl)
            {
                <div class="share-section">
                    <h3>Share this level:</h3>
                    <div class="share-url-box">
                        <input type="text" readonly @bind="shareUrl" class="share-url-input" @onclick="SelectShareUrl" />
                        <button class="copy-button" @onclick="CopyToClipboard">Copy</button>
                    </div>
                    <p class="share-hint">Share this URL with others to let them play your level!</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">
                    @errorMessage
                </div>
            }
        </div>
        
        <div class="level-preview">
            <h3>Preview</h3>
            <InteractiveGameGrid 
                Snake="@GetPreviewSnake()"
                Apples="@GetPreviewApples()"
                Portal="@GetPreviewPortal()"
                GroundBlocks="@GetPreviewGroundBlocks()"
                PushableBlocks="@GetPreviewPushableBlocks()"
                Bombs="@GetPreviewBombs()"
                OnCellClicked="@HandleCellClick" />
            <p class="preview-hint">Live preview of your level (invalid positions are ignored)<br/>
               @if (!string.IsNullOrEmpty(focusedField))
               {
                   <span>Click empty cells to add @focusedField positions, or click filled cells to remove them.</span>
               }
               else
               {
                   <span>Focus a position text box to add positions by clicking.</span>
               }
            </p>
        </div>
    </div>
    }
    else if (levelWon)
    {
        <div class="level-complete">
            <h2>üéâ Level Complete! üéâ</h2>
            <p>You reached the portal!</p>
            <div class="completion-buttons">
                <button class="game-button" @onclick="BackToEditor">Back to Editor</button>
                <button class="game-button secondary" @onclick="BackToMenu">Main Menu</button>
            </div>
        </div>
    }
    else if (gameOver)
    {
        <div class="game-over">
            <h2>üí• Game Over! üí•</h2>
            <p>@gameOverReason</p>
            <div class="completion-buttons">
                <button class="game-button" @onclick="RetryLevel">Retry Level</button>
                <button class="game-button secondary" @onclick="BackToEditor">Back to Editor</button>
            </div>
        </div>
    }
    else
    {
        <GameGrid 
            Snake="@GameEngine.Snake"
            Apples="@GameEngine.Apples"
            Portal="@GameEngine.PortalPosition"
            GroundBlocks="@GameEngine.GroundBlocks"
            PushableBlocks="@GameEngine.PushableBlocks"
            Bombs="@GameEngine.Bombs" />
        <div class="controls">
            <div class="button-row">
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Up)">‚ñ≤</button>
            </div>
            <div class="button-row">
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Left)">‚óÑ</button>
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Down)">‚ñº</button>
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Right)">‚ñ∫</button>
            </div>
            <div class="button-row">
                <button class="game-button" @onclick="RetryLevel">Retry</button>
                <button class="game-button secondary" @onclick="BackToEditor">Back to Editor</button>
            </div>
        </div>
    }
</div>

@code {
    private const int GridSize = 20;

    // Editor fields
    private string description = "";
    private string portalInput = "";
    private string snakeInput = "";
    private string applesInput = "";
    private string groundInput = "";
    private string pushableInput = "";
    private string bombsInput = "";
    private string errorMessage = "";
    private bool showShareUrl = false;
    private string shareUrl = "";
    private string focusedField = "";
    private bool showSavePrompt = false;
    private string saveLevelName = "";
    private Dictionary<string, string> savedLevels = new();

    // Element references for focus management
    private ElementReference portalInputRef;
    private ElementReference snakeInputRef;
    private ElementReference applesInputRef;
    private ElementReference groundInputRef;
    private ElementReference pushableInputRef;
    private ElementReference bombsInputRef;

    // Game state - use GameEngine properties
    private bool levelStarted = false;
    private bool levelWon => GameEngine.LevelWon;
    private bool gameOver => GameEngine.GameOver;
    private string gameOverReason => GameEngine.GameOverReason;

    // Store original config for retry
    private LevelConfig? currentConfig = null;

    protected override void OnInitialized()
    {
        // Subscribe to game engine state changes
        GameEngine.OnStateChanged += HandleGameEngineStateChanged;
        
        LoadFromUrl();
    }
    
    private void HandleGameEngineStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupKeyboardHandler", DotNetObjectReference.Create(this));
            await LoadSavedLevelsFromStorage();
        }
    }

    private void LoadFromUrl()
    {
        var uri = new Uri(NavigationManager.Uri);
        var query = uri.Query.TrimStart('?');
        
        if (string.IsNullOrEmpty(query))
            return;

        var parameters = query.Split('&');
        foreach (var param in parameters)
        {
            var equalIndex = param.IndexOf('=');
            if (equalIndex < 0) continue;

            var key = param.Substring(0, equalIndex);
            var value = System.Net.WebUtility.UrlDecode(param.Substring(equalIndex + 1));

            switch (key)
            {
                case "D":
                    description = value;
                    break;
                case "E":
                    portalInput = value;
                    break;
                case "S":
                    snakeInput = value;
                    break;
                case "A":
                    applesInput = value;
                    break;
                case "G":
                    groundInput = value;
                    break;
                case "P":
                    pushableInput = value;
                    break;
                case "B":
                    bombsInput = value;
                    break;
            }
        }

        // If we have data in the URL, auto-play the level
        if (!string.IsNullOrEmpty(snakeInput) && !string.IsNullOrEmpty(portalInput))
        {
            PlayLevel();
        }
    }

    private void PlayLevel()
    {
        try
        {
            errorMessage = "";
            showShareUrl = false;

            // Validate required fields
            if (!ValidateLevel(out var validationError))
            {
                errorMessage = validationError;
                return;
            }

            var compactString = BuildCompactString();
            currentConfig = LevelConfig.Parse(compactString);
            
            InitializeGame(currentConfig);
            levelStarted = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private bool ValidateLevel(out string error)
    {
        error = "";

        // Validate End Portal (required)
        if (string.IsNullOrWhiteSpace(portalInput))
        {
            error = "End Portal position is required (format: row,col)";
            return false;
        }
        try
        {
            ParsePosition(portalInput.Trim(), "End Portal");
        }
        catch (Exception ex)
        {
            error = ex.Message;
            return false;
        }

        // Validate Snake (required, at least 1 segment)
        if (string.IsNullOrWhiteSpace(snakeInput))
        {
            error = "Snake segments are required (format: row,col;row,col;... with head first)";
            return false;
        }
        try
        {
            var snakeSegments = ParsePositionList(snakeInput.Trim(), "Snake");
            if (snakeSegments.Count == 0)
            {
                error = "Snake must have at least 1 segment";
                return false;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
            return false;
        }

        // Validate Ground Blocks (required, at least 3)
        if (string.IsNullOrWhiteSpace(groundInput))
        {
            error = "Ground blocks are required (at least 3 blocks for support)";
            return false;
        }
        try
        {
            var groundBlocks = ParsePositionList(groundInput.Trim(), "Ground Blocks");
            if (groundBlocks.Count < 3)
            {
                error = $"Ground blocks must have at least 3 blocks (found {groundBlocks.Count})";
                return false;
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
            return false;
        }

        // Validate optional fields if provided
        if (!string.IsNullOrWhiteSpace(applesInput))
        {
            try
            {
                ParsePositionList(applesInput.Trim(), "Apples");
            }
            catch (Exception ex)
            {
                error = ex.Message;
                return false;
            }
        }

        if (!string.IsNullOrWhiteSpace(pushableInput))
        {
            try
            {
                ParsePositionList(pushableInput.Trim(), "Pushable Blocks");
            }
            catch (Exception ex)
            {
                error = ex.Message;
                return false;
            }
        }

        if (!string.IsNullOrWhiteSpace(bombsInput))
        {
            try
            {
                ParsePositionList(bombsInput.Trim(), "Bombs");
            }
            catch (Exception ex)
            {
                error = ex.Message;
                return false;
            }
        }

        return true;
    }

    private Position ParsePosition(string posStr, string sectionName)
    {
        var parts = posStr.Split(',');
        if (parts.Length != 2)
        {
            throw new Exception($"{sectionName}: Invalid position format '{posStr}' (expected: row,col)");
        }
        
        if (!int.TryParse(parts[0].Trim(), out int row))
        {
            throw new Exception($"{sectionName}: Invalid row value '{parts[0].Trim()}' in position '{posStr}'");
        }
        
        if (!int.TryParse(parts[1].Trim(), out int col))
        {
            throw new Exception($"{sectionName}: Invalid column value '{parts[1].Trim()}' in position '{posStr}'");
        }

        if (row < 0 || row >= 20 || col < 0 || col >= 20)
        {
            throw new Exception($"{sectionName}: Position ({row},{col}) is out of bounds (grid is 0-19)");
        }

        return new Position(row, col);
    }

    private List<Position> ParsePositionList(string positionsStr, string sectionName)
    {
        var positions = new List<Position>();
        var parts = positionsStr.Split(';')
            .Select(p => p.Trim())
            .Where(p => !string.IsNullOrWhiteSpace(p))
            .ToArray();

        if (parts.Length == 0)
        {
            throw new Exception($"{sectionName}: No valid positions found");
        }

        foreach (var part in parts)
        {
            positions.Add(ParsePosition(part, sectionName));
        }

        return positions;
    }

    private void RetryLevel()
    {
        if (currentConfig != null)
        {
            InitializeGame(currentConfig);
            levelStarted = true;
        }
    }

    private void ShareLevel()
    {
        try
        {
            errorMessage = "";
            
            // Validate before sharing
            if (!ValidateLevel(out var validationError))
            {
                errorMessage = validationError;
                return;
            }

            var compactString = BuildCompactString();
            
            // Test parse to validate
            LevelConfig.Parse(compactString);
            
            // Build share URL
            var baseUrl = NavigationManager.BaseUri;
            shareUrl = $"{baseUrl}snake/custom?{compactString}";
            showShareUrl = true;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private string BuildCompactString()
    {
        var parts = new List<string>();

        if (!string.IsNullOrWhiteSpace(description))
            parts.Add($"D={System.Net.WebUtility.UrlEncode(description)}");
        
        if (!string.IsNullOrWhiteSpace(portalInput))
            parts.Add($"E={portalInput.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(snakeInput))
            parts.Add($"S={snakeInput.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(applesInput))
            parts.Add($"A={applesInput.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(groundInput))
            parts.Add($"G={groundInput.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(pushableInput))
            parts.Add($"P={pushableInput.Trim()}");
        
        if (!string.IsNullOrWhiteSpace(bombsInput))
            parts.Add($"B={bombsInput.Trim()}");

        return string.Join("&", parts);
    }

    private async Task SelectShareUrl()
    {
        await JSRuntime.InvokeVoidAsync("eval", "event.target.select()");
    }

    private async Task CopyToClipboard()
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", shareUrl);
    }

    private void BackToEditor()
    {
        levelStarted = false;
        showShareUrl = false;
    }

    private void BackToMenu()
    {
        NavigationManager.NavigateTo("/snake");
    }

    // Save/Load/Delete functionality
    private async Task LoadSavedLevelsFromStorage()
    {
        try
        {
            var levelsJson = await JSRuntime.InvokeAsync<Dictionary<string, string>>("getSavedLevels");
            savedLevels = levelsJson ?? new Dictionary<string, string>();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading saved levels: {ex.Message}");
            savedLevels = new Dictionary<string, string>();
        }
    }

    private void SaveLevel()
    {
        // Validate before showing save prompt
        if (!ValidateLevel(out var validationError))
        {
            errorMessage = validationError;
            return;
        }

        errorMessage = "";
        showShareUrl = false;
        showSavePrompt = true;
        saveLevelName = description; // Pre-fill with description
    }

    private void CancelSave()
    {
        showSavePrompt = false;
        saveLevelName = "";
    }

    private async Task ConfirmSaveLevel()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(saveLevelName))
            {
                errorMessage = "Please enter a name for the level";
                return;
            }

            var compactString = BuildCompactString();
            
            // Save to localStorage via JavaScript
            var success = await JSRuntime.InvokeAsync<bool>("saveCustomLevel", saveLevelName, compactString);
            
            if (success)
            {
                savedLevels[saveLevelName] = compactString;
                showSavePrompt = false;
                saveLevelName = "";
                errorMessage = "";
                StateHasChanged();
            }
            else
            {
                errorMessage = "Failed to save level. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving level: {ex.Message}";
        }
    }

    private void LoadSavedLevel(string levelName)
    {
        try
        {
            if (!savedLevels.ContainsKey(levelName))
            {
                errorMessage = "Level not found";
                return;
            }

            var compactString = savedLevels[levelName];
            var parameters = compactString.Split('&');
            
            // Reset all fields
            description = "";
            portalInput = "";
            snakeInput = "";
            applesInput = "";
            groundInput = "";
            pushableInput = "";
            bombsInput = "";
            
            // Parse the saved level data
            foreach (var param in parameters)
            {
                var equalIndex = param.IndexOf('=');
                if (equalIndex < 0) continue;

                var key = param.Substring(0, equalIndex);
                var value = System.Net.WebUtility.UrlDecode(param.Substring(equalIndex + 1));

                switch (key)
                {
                    case "D":
                        description = value;
                        break;
                    case "E":
                        portalInput = value;
                        break;
                    case "S":
                        snakeInput = value;
                        break;
                    case "A":
                        applesInput = value;
                        break;
                    case "G":
                        groundInput = value;
                        break;
                    case "P":
                        pushableInput = value;
                        break;
                    case "B":
                        bombsInput = value;
                        break;
                }
            }

            errorMessage = "";
            showShareUrl = false;
            showSavePrompt = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading level: {ex.Message}";
        }
    }

    private async Task DeleteSavedLevel(string levelName)
    {
        try
        {
            var success = await JSRuntime.InvokeAsync<bool>("deleteCustomLevel", levelName);
            
            if (success)
            {
                savedLevels.Remove(levelName);
                errorMessage = "";
                StateHasChanged();
            }
            else
            {
                errorMessage = "Failed to delete level. Please try again.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting level: {ex.Message}";
        }
    }

    // Preview helper methods - parse without throwing exceptions
    
    // Reusable helper to convert semicolon-delimited position strings to List<Position>
    private List<Position> ParsePositionListSafe(string input)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(input))
                return new List<Position>();
            
            return input.Split(';')
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .Select(p => TryParsePosition(p))
                .OfType<Position>()
                .ToList();
        }
        catch
        {
            return new List<Position>();
        }
    }

    private List<Position> GetPreviewSnake() => ParsePositionListSafe(snakeInput);

    private List<Position> GetPreviewApples() => ParsePositionListSafe(applesInput);

    private Position? GetPreviewPortal()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(portalInput))
                return null;
            
            return TryParsePosition(portalInput.Trim());
        }
        catch
        {
            return null;
        }
    }

    private List<Position> GetPreviewGroundBlocks() => ParsePositionListSafe(groundInput);

    private List<Position> GetPreviewPushableBlocks() => ParsePositionListSafe(pushableInput);

    private List<Position> GetPreviewBombs() => ParsePositionListSafe(bombsInput);

    private Position? TryParsePosition(string posStr)
    {
        try
        {
            var parts = posStr.Split(',');
            if (parts.Length != 2)
                return null;
            
            if (!int.TryParse(parts[0].Trim(), out int row))
                return null;
            
            if (!int.TryParse(parts[1].Trim(), out int col))
                return null;

            if (row < 0 || row >= 20 || col < 0 || col >= 20)
                return null;

            return new Position(row, col);
        }
        catch
        {
            return null;
        }
    }

    private async Task HandleCellClick((int row, int col, string cellType) clickInfo)
    {
        var posStr = $"{clickInfo.row},{clickInfo.col}";
        
        // If cell is not empty, remove it from the appropriate field and set focus to that field
        if (!string.IsNullOrEmpty(clickInfo.cellType))
        {
            await RemovePositionFromFieldAndFocus(posStr, clickInfo.cellType);
            StateHasChanged();
        }
        // If cell is empty and a field has focus, add position to that field
        else if (!string.IsNullOrEmpty(focusedField))
        {
            AddPositionToField(posStr, focusedField);
            StateHasChanged();
        }
    }

    private async Task RemovePositionFromFieldAndFocus(string posStr, string cellType)
    {
        // Determine which field to remove from based on cell type
        switch (cellType)
        {
            case "snake-head":
            case "snake-body":
                RemovePosition(ref snakeInput, posStr);
                focusedField = "snake";
                await JSRuntime.InvokeVoidAsync("eval", $"document.querySelector('input[placeholder=\"17,3;17,2;17,1\"]').focus()");
                await snakeInputRef.FocusAsync();
                break;
            case "apple":
                RemovePosition(ref applesInput, posStr);
                focusedField = "apples";
                await applesInputRef.FocusAsync();
                break;
            case "portal":
                portalInput = "";
                focusedField = "portal";
                await portalInputRef.FocusAsync();
                break;
            case "ground-block":
                RemovePosition(ref groundInput, posStr);
                focusedField = "ground";
                await groundInputRef.FocusAsync();
                break;
            case "pushable-block":
                RemovePosition(ref pushableInput, posStr);
                focusedField = "pushable";
                await pushableInputRef.FocusAsync();
                break;
            case "bomb":
                RemovePosition(ref bombsInput, posStr);
                focusedField = "bombs";
                await bombsInputRef.FocusAsync();
                break;
        }
    }

    private void RemovePosition(ref string field, string posStr)
    {
        if (string.IsNullOrWhiteSpace(field))
            return;

        var positions = field.Split(';', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .Where(p => p != posStr)
            .ToList();

        field = string.Join(";", positions);
    }

    private void AddPositionToField(string posStr, string fieldName)
    {
        switch (fieldName)
        {
            case "portal":
                portalInput = posStr;
                break;
            case "snake":
                AppendPosition(ref snakeInput, posStr);
                break;
            case "apples":
                AppendPosition(ref applesInput, posStr);
                break;
            case "ground":
                AppendPosition(ref groundInput, posStr);
                break;
            case "pushable":
                AppendPosition(ref pushableInput, posStr);
                break;
            case "bombs":
                AppendPosition(ref bombsInput, posStr);
                break;
        }
    }

    private void AppendPosition(ref string field, string posStr)
    {
        if (!field.Contains(posStr))
        {
            field = field.TrimEnd(';') + ";" + posStr;
        }
    }

    private void InitializeGame(LevelConfig config)
    {
        GameEngine.InitializeGame(
            config.SnakeSegments,
            config.Apples,
            config.Portal,
            config.GroundBlocks,
            config.PushableBlocks,
            config.Bombs
        );
    }

    private void ChangeDirection(Services.Direction newDirection)
    {
        if (levelWon || gameOver || GameEngine.IsAnimating)
            return;

        // Use synchronous version without animation for custom level editor
        GameEngine.MoveSnake(newDirection);
    }

    [JSInvokable]
    public void HandleKeyPress(string key)
    {
        if (!levelStarted || levelWon || gameOver || GameEngine.IsAnimating)
            return;

        var direction = key switch
        {
            "ArrowUp" => Services.Direction.Up,
            "ArrowDown" => Services.Direction.Down,
            "ArrowLeft" => Services.Direction.Left,
            "ArrowRight" => Services.Direction.Right,
            _ => (Services.Direction?)null
        };

        if (direction.HasValue)
        {
            ChangeDirection(direction.Value);
        }
    }

    public void Dispose()
    {
        // Unsubscribe from game engine events
        GameEngine.OnStateChanged -= HandleGameEngineStateChanged;
        
        // Clean up keyboard handler
        JSRuntime.InvokeVoidAsync("cleanupKeyboardHandler");
    }
    
    private record LevelConfig(
        string Description,
        List<Position> SnakeSegments,
        List<Position> Apples,
        Position Portal,
        List<Position> GroundBlocks,
        List<Position> PushableBlocks,
        List<Position> Bombs
    )
    {
        public static LevelConfig Parse(string compact)
        {
            var description = "";
            var snakeSegments = new List<Position>();
            var apples = new List<Position>();
            Position? portal = null;
            var groundBlocks = new List<Position>();
            var pushableBlocks = new List<Position>();
            var bombs = new List<Position>();

            var sections = compact.Split('&');
            foreach (var section in sections)
            {
                if (string.IsNullOrWhiteSpace(section)) continue;
                
                var equalIndex = section.IndexOf('=');
                if (equalIndex < 0) continue;

                var sectionType = section[0];
                var sectionData = section.Substring(equalIndex + 1);

                switch (sectionType)
                {
                    case 'D':
                        description = System.Net.WebUtility.UrlDecode(sectionData);
                        break;
                    case 'E':
                        portal = ParsePosition(sectionData);
                        break;
                    case 'S':
                        snakeSegments = ParsePositions(sectionData);
                        break;
                    case 'A':
                        apples = ParsePositions(sectionData);
                        break;
                    case 'G':
                        groundBlocks = ParsePositions(sectionData);
                        break;
                    case 'P':
                        pushableBlocks = ParsePositions(sectionData);
                        break;
                    case 'B':
                        bombs = ParsePositions(sectionData);
                        break;
                }
            }

            return new LevelConfig(
                description,
                snakeSegments,
                apples,
                portal ?? new Position(0, 0),
                groundBlocks,
                pushableBlocks,
                bombs
            );
        }

        private static Position ParsePosition(string pos)
        {
            var parts = pos.Split(',');
            return new Position(int.Parse(parts[0]), int.Parse(parts[1]));
        }

        private static List<Position> ParsePositions(string positions)
        {
            if (string.IsNullOrWhiteSpace(positions))
                return new List<Position>();

            return positions.Split(';')
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .Select(p => ParsePosition(p))
                .ToList();
        }
    };
}

