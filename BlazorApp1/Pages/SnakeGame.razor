@page "/snake"
@page "/snake/{LevelNumber:int}"
@implements IDisposable
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject BlazorApp1.Services.SnakeGameEngine GameEngine

<PageTitle>Snake Game</PageTitle>

<h1>Snake Game</h1>

<div class="game-container">
    @if (!levelStarted)
    {
        <div class="level-selection">
            <h2>Select Level</h2>
            <div class="level-buttons">
                @foreach (var level in levels)
                {
                    <button class="level-button" @onclick="() => StartLevel(level.Key)">
                        <div class="level-number">Level @level.Key</div>
                        <div class="level-desc">@level.Value.Description</div>
                    </button>
                }
                <button class="level-button custom-level" @onclick="GoToCustomLevel">
                    <div class="level-number">‚öôÔ∏è</div>
                    <div class="level-desc">Custom Level</div>
                </button>
            </div>
        </div>
    }
    else if (levelWon)
    {
        <div class="level-complete">
            <h2>üéâ Level @currentLevel Complete! üéâ</h2>
            <p>You reached the portal!</p>
            <div class="completion-buttons">
                @if (currentLevel < levels.Count)
                {
                    <button class="game-button" @onclick="() => StartLevel(currentLevel + 1)">Next Level</button>
                }
                else
                {
                    <p class="victory-text">You've completed all levels!</p>
                }
                <button class="game-button" @onclick="BackToLevelSelect">Level Select</button>
            </div>
        </div>
    }
    else if (gameOver)
    {
        <div class="game-over">
            <h2>üí• Game Over! üí•</h2>
            <p>@gameOverReason</p>
            <div class="completion-buttons">
                <button class="game-button" @onclick="() => StartLevel(currentLevel)">Retry Level</button>
                <button class="game-button secondary" @onclick="BackToLevelSelect">Level Select</button>
            </div>
        </div>
    }
    else
    {
        <GameGrid 
            Snake="@GameEngine.Snake"
            Apples="@GameEngine.Apples"
            Portal="@GameEngine.PortalPosition"
            GroundBlocks="@GameEngine.GroundBlocks"
            PushableBlocks="@GameEngine.PushableBlocks"
            Bombs="@GameEngine.Bombs" />
        <div class="controls">
            <div class="button-row">
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Up)">‚ñ≤</button>
            </div>
            <div class="button-row">
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Left)">‚óÑ</button>
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Down)">‚ñº</button>
                <button class="arrow-button" @onclick="() => ChangeDirection(Services.Direction.Right)">‚ñ∫</button>
            </div>
            <div class="button-row">
                <button class="game-button" @onclick="() => StartLevel(currentLevel)">Retry</button>
                <button class="game-button secondary" @onclick="BackToLevelSelect">Back to Level Select</button>
                <button class="game-button" @onclick="CustomizeCurrentLevel">Customize</button>
            </div>
        </div>
    }
</div>

@code {
    private const int GridSize = 20;

    [Parameter]
    public int? LevelNumber { get; set; }

    private int currentLevel = 1;
    private bool levelStarted = false;
    
    // Use GameEngine properties instead of local state
    private bool levelWon => GameEngine.LevelWon;
    private bool gameOver => GameEngine.GameOver;
    private string gameOverReason => GameEngine.GameOverReason;

    private Dictionary<int, LevelConfig> levels = new()
    {
        { 1, LevelConfig.Parse("D=Jump the gap&E=17,14&S=17,3;17,2;17,1&G=18,2;18,3;18,4;18,5;18,6;18,9;18,10;18,11;18,12;18,13;18,14;18,15") },
        { 2, LevelConfig.Parse("D=Climb the cliff&E=14,14&S=17,2;17,1;18,1&G=18,1;18,2;18,3;18,4;18,5;18,6;18,7;17,8;16,8;15,8;15,9;15,10;15,11;15,12;15,13;15,14;15,15;15,16&P=17,5") },
        { 3, LevelConfig.Parse("D=Cover the bomb&E=17,15&S=17,2;17,1&G=18,1;18,2;18,3;18,4;18,5;18,6;18,7;18,8;18,9;18,10;18,11;18,12;18,13;18,14;18,15;18,16&P=17,5&B=17,10") },
        { 4, LevelConfig.Parse("D=Collect all apples&E=10,10&S=17,2;17,1;18,1&A=17,6;15,10;17,14&G=18,1;18,2;18,3;18,4;18,5;18,6;18,7;18,8;18,9;18,10;18,11;18,12;16,9;16,10;16,11;18,13;18,14&P=17,8") },
        { 5, LevelConfig.Parse("D=Hangover&E=12,10&S=16,5;16,4;16,3&A=14,10&G=17,4;17,5;17,6;17,7;17,8;17,9;13,9;13,10;13,11;15,9;16,9;15,10;15,11;17,3") },
        { 6, LevelConfig.Parse("D=Order up&E=12,1&S=17,3;17,2;17,1&A=17,8;15,14&G=18,1;18,2;18,3;18,4;18,5;18,11;18,12;18,13;18,14;16,6;16,7;16,9;16,10;18,6") },
        { 7, LevelConfig.Parse("D=Cave of Wonders&E=11,16&S=17,2;17,1;16,1&A=17,7;17,6;16,7;16,6;17,13;17,18;17,19&G=18,1;18,2;18,3;18,4;18,5;18,14;18,15;18,16;18,17;14,8;14,9;14,10;14,11;16,5;18,6;18,7;18,8;17,8;16,8;15,8;15,7;15,6;15,11;15,12") },
        { 8, LevelConfig.Parse("D=Trust fall&E=17,16&S=17,5;17,4;17,3&A=15,14;15,9;14,14&G=18,3;18,4;18,5;14,15;16,15;15,10;15,15;13,15;17,8;17,7;14,9;14,8;14,13;12,15;12,14;12,13;12,12;13,9;12,11;15,13;16,13;17,13;19,12;19,13;18,15;17,15;19,11;19,10;16,10;19,6;19,7;19,8;19,9&P=18,12&B=18,9") },
        { 9, LevelConfig.Parse("D=U-Turn&E=14,15&S=17,2;17,1;16,1&A=17,9&G=18,1;18,2;18,3;18,4;18,5;18,6;18,7;18,8;18,9;18,10;18,12;18,13;18,14;18,15;18,16;15,4;15,5;15,7;15,10;15,11;15,12;15,13;15,14;15,15;15,16;15,6;16,7;15,8;15,9;18,11;17,10;17,16;16,16&P=17,5;17,13") },
        { 10, LevelConfig.Parse("D=Get in shape&E=14,19&S=14,4;14,3;14,2;14,1&A=14,8;6,6&G=12,7;12,8;15,4;15,5;15,6;15,7;15,8;15,9;15,10;15,11;15,3;15,2;15,1;12,6;13,6;12,12;12,9;14,9;11,10;11,11;11,12;14,12;13,12;11,6;7,6;15,12;15,13;15,14;15,15;16,16;16,17;16,18;16,19;16,15&P=11,8&B=14,14;14,15") },
        { 11, LevelConfig.Parse("D=Stairway to portal&E=15,13&S=;17,8;17,7;17,6&A=15,10;14,11;13,12&G=18,8;16,10;14,12;13,14;15,11;13,13;17,9;18,17;18,18&B=16,16;12,17;15,15;14,14;16,13;17,13;17,14") },
        { 12, LevelConfig.Parse("D=Bomb corridor&E=17,17&S=17,2;17,1;16,1&A=15,12&G=18,1;18,2;18,3;18,4;18,5;18,6;18,7;18,8;18,9;18,10;18,11;18,12;18,13;18,14;18,15;18,16;18,17;14,5;14,6;14,7;14,8;14,9;14,10;14,11;14,12;14,13;14,14;14,15;14,16;14,17;16,5;16,17&P=17,7;17,14&B=15,7;15,9;15,11;15,14;15,16") }
    };

    protected override void OnInitialized()
    {
        // Subscribe to game engine state changes
        GameEngine.OnStateChanged += HandleGameEngineStateChanged;
        
        // If a level number is specified in the URL, start that level automatically
        if (LevelNumber.HasValue && levels.ContainsKey(LevelNumber.Value))
        {
            StartLevel(LevelNumber.Value);
        }
    }
    
    private void HandleGameEngineStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    protected override void OnParametersSet()
    {
        // Handle level changes when navigating between different level URLs
        if (LevelNumber.HasValue && levels.ContainsKey(LevelNumber.Value))
        {
            // Only restart if we're navigating to a different level
            if (currentLevel != LevelNumber.Value || !levelStarted)
            {
                StartLevel(LevelNumber.Value);
            }
        }
        else if (!LevelNumber.HasValue)
        {
            // If no level is specified in URL, return to level select
            levelStarted = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupKeyboardHandler", DotNetObjectReference.Create(this));
        }
    }

    private void StartLevel(int level)
    {
        if (!levels.ContainsKey(level))
            return;

        currentLevel = level;
        levelStarted = true;

        var config = levels[level];
        InitializeGame(config);
    }

    private void BackToLevelSelect()
    {
        levelStarted = false;
    }

    private void GoToCustomLevel()
    {
        NavigationManager.NavigateTo("/snake/custom");
    }

    private void CustomizeCurrentLevel()
    {
        // Build the current level config
        var config = new LevelConfig(
            $"Level {currentLevel}",
            GameEngine.Snake.ToList(),
            GameEngine.Apples.ToList(),
            GameEngine.PortalPosition,
            GameEngine.GroundBlocks.ToList(),
            GameEngine.PushableBlocks.ToList(),
            GameEngine.Bombs.ToList()
        );

        // Navigate to custom level with current state as URL parameters
        var compactString = config.ToCompactString();
        NavigationManager.NavigateTo($"/snake/custom?{compactString}");
    }

    private void InitializeGame(LevelConfig config)
    {
        GameEngine.InitializeGame(
            config.SnakeSegments,
            config.Apples,
            config.Portal,
            config.GroundBlocks,
            config.PushableBlocks,
            config.Bombs
        );
    }

    private async Task ChangeDirection(Services.Direction newDirection)
    {
        if (levelWon || gameOver || GameEngine.IsAnimating)
            return;

        // Move the snake using game engine
        await GameEngine.MoveSnakeWithAnimatedGravity(newDirection);
    }


    [JSInvokable]
    public async Task HandleKeyPress(string key)
    {
        if (!levelStarted || levelWon || gameOver || GameEngine.IsAnimating)
            return;

        var direction = key switch
        {
            "ArrowUp" => Services.Direction.Up,
            "ArrowDown" => Services.Direction.Down,
            "ArrowLeft" => Services.Direction.Left,
            "ArrowRight" => Services.Direction.Right,
            _ => (Services.Direction?)null
        };

        if (direction.HasValue)
        {
            await ChangeDirection(direction.Value);
            StateHasChanged(); // Force UI update after processing keyboard input
        }
    }


    public void Dispose()
    {
        // Unsubscribe from game engine events
        GameEngine.OnStateChanged -= HandleGameEngineStateChanged;
        
        // Clean up keyboard handler
        JSRuntime.InvokeVoidAsync("cleanupKeyboardHandler");
    }

    private record LevelConfig(
        string Description,
        List<Position> SnakeSegments,
        List<Position> Apples,
        Position Portal,
        List<Position> GroundBlocks,
        List<Position> PushableBlocks,
        List<Position> Bombs
    )
    {
        public static LevelConfig Parse(string compact)
        {
            var description = "";
            var snakeSegments = new List<Position>();
            var apples = new List<Position>();
            Position? portal = null;
            var groundBlocks = new List<Position>();
            var pushableBlocks = new List<Position>();
            var bombs = new List<Position>();

            var sections = compact.Split('&');
            foreach (var section in sections)
            {
                if (string.IsNullOrWhiteSpace(section)) continue;
                
                var equalIndex = section.IndexOf('=');
                if (equalIndex < 0) continue;

                var sectionType = section[0];
                var sectionData = section.Substring(equalIndex + 1);

                switch (sectionType)
                {
                    case 'D':
                        description = sectionData;
                        break;
                    case 'E':
                        portal = ParsePosition(sectionData);
                        break;
                    case 'S':
                        snakeSegments = ParsePositions(sectionData);
                        break;
                    case 'A':
                        apples = ParsePositions(sectionData);
                        break;
                    case 'G':
                        groundBlocks = ParsePositions(sectionData);
                        break;
                    case 'P':
                        pushableBlocks = ParsePositions(sectionData);
                        break;
                    case 'B':
                        bombs = ParsePositions(sectionData);
                        break;
                }
            }

            return new LevelConfig(
                description,
                snakeSegments,
                apples,
                portal ?? new Position(0, 0),
                groundBlocks,
                pushableBlocks,
                bombs
            );
        }

        private static Position ParsePosition(string pos)
        {
            var parts = pos.Split(',');
            return new Position(int.Parse(parts[0]), int.Parse(parts[1]));
        }

        private static List<Position> ParsePositions(string positions)
        {
            if (string.IsNullOrWhiteSpace(positions))
                return new List<Position>();

            return positions.Split(';')
                .Select(p => p.Trim())
                .Where(p => !string.IsNullOrWhiteSpace(p))
                .Select(p => ParsePosition(p))
                .ToList();
        }

        public string ToCompactString()
        {
            var parts = new List<string>();
            
            parts.Add($"D={Description}");
            parts.Add($"E={Portal.Row},{Portal.Col}");
            
            if (SnakeSegments.Any())
                parts.Add($"S={string.Join(";", SnakeSegments.Select(p => $"{p.Row},{p.Col}"))}");
            
            if (Apples.Any())
                parts.Add($"A={string.Join(";", Apples.Select(p => $"{p.Row},{p.Col}"))}");
            
            if (GroundBlocks.Any())
                parts.Add($"G={string.Join(";", GroundBlocks.Select(p => $"{p.Row},{p.Col}"))}");
            
            if (PushableBlocks.Any())
                parts.Add($"P={string.Join(";", PushableBlocks.Select(p => $"{p.Row},{p.Col}"))}");
            
            if (Bombs.Any())
                parts.Add($"B={string.Join(";", Bombs.Select(p => $"{p.Row},{p.Col}"))}");
            
            return string.Join("&", parts);
        }
    };
}

